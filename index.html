<script>
  const tabs = {
    audio: document.getElementById("tab-audio"),
    text: document.getElementById("tab-text"),
    prescription: document.getElementById("tab-prescription")
  };
  const panels = {
    audio: document.getElementById("panel-audio"),
    text: document.getElementById("panel-text"),
    prescription: document.getElementById("panel-prescription")
  };

  function activateTab(key) {
    Object.keys(tabs).forEach(k => {
      if (k === key) {
        tabs[k].classList.add("bg-white","text-slate-900","shadow-sm");
        tabs[k].classList.remove("text-slate-500");
        panels[k].classList.remove("hidden");
      } else {
        tabs[k].classList.remove("bg-white","text-slate-900","shadow-sm");
        tabs[k].classList.add("text-slate-500");
        panels[k].classList.add("hidden");
      }
    });
  }

  tabs.audio.onclick = () => activateTab("audio");
  tabs.text.onclick = () => activateTab("text");
  tabs.prescription.onclick = () => activateTab("prescription");

  const jargonMap = [
    ["acute","sudden or very recent"],
    ["chronic","long-term or ongoing"],
    ["exacerbation","worsening or flare-up"],
    ["hypertension","high blood pressure"],
    ["hypotension","low blood pressure"],
    ["tachycardia","fast heartbeat"],
    ["bradycardia","slow heartbeat"],
    ["myocardial infarction","heart attack"],
    ["ischemia","not enough blood flow"],
    ["edema","swelling caused by extra fluid"],
    ["lesion","abnormal patch or spot on the body"],
    ["benign","not cancer and usually not dangerous"],
    ["malignant","cancerous and can spread"],
    ["prognosis","how the illness is likely to go in future"],
    ["diagnosis","name of the illness or condition"],
    ["respiratory distress","serious trouble breathing"],
    ["dehydration","not enough fluid in the body"],
    ["intravenous","through a vein using a drip or injection"],
    ["oral","by mouth"],
    ["topical","applied on the skin"],
    ["symptomatic relief","treatment that reduces discomfort but does not remove the cause"],
    ["monitor","keep watching carefully"],
    ["follow-up","come back again for review"],
    ["presented with","came to the doctor because of"],
    ["contraindicated","should not be used because it may be harmful"],
    ["adverse reaction","harmful or unwanted side effect"],
    ["labs","blood tests or other investigations"],
    ["vitals","basic body signs like pulse, blood pressure, temperature and breathing rate"],
    ["antibiotics","medicines used to treat bacterial infections"],
    ["infection","germs in the body causing illness"],
    ["inflammation","swelling, heat, or redness in part of the body"],
    ["idiopathic","cause is unknown"],
    ["metastasis","spread of cancer to other parts of the body"],
    ["remission","time when signs of disease reduce or disappear"],
    ["palliative","focused on comfort rather than cure"],
    ["analgesic","pain-relief medicine"],
    ["antipyretic","medicine that reduces fever"],
    ["NSAID","a type of pain and inflammation medicine"],
    ["bradykinesia","slowness of movement, usually due to a problem in the brain's movement centres, often seen in Parkinson's disease"]
  ];

  const phraseReplacements = [
    ["the patient","you"],
    ["patient","you"],
    ["pt","you"],
    ["presents with","came because of"],
    ["presented with","came because of"],
    ["should be started on","you will start taking"],
    ["will be started on","you will start taking"],
    ["start on","start taking"],
    ["start","start taking"],
    ["will be monitored","we will keep watching"],
    ["needs to","you need to"],
    ["recommended","the doctor recommends"],
    ["advise","the doctor advises you to"]
  ];

  function simplifyTerms(text, extraSimple) {
    let out = text;

    jargonMap.forEach(([term, plain]) => {
      const pattern = new RegExp("\\b" + term.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&") + "\\b","gi");
      out = out.replace(pattern, plain);
    });

    phraseReplacements.forEach(([from, to]) => {
      const pattern = new RegExp("\\b" + from.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&") + "\\b","gi");
      out = out.replace(pattern, to);
    });

    if (extraSimple) {
      out = out
        .replace(/\badminister\b/gi,"give")
        .replace(/\bcommence\b/gi,"start")
        .replace(/\bdiscontinue\b/gi,"stop")
        .replace(/\bconsume\b/gi,"take")
        .replace(/\bprior to\b/gi,"before")
        .replace(/\bsubsequently\b/gi,"then");
    }

    return out;
  }

  function splitSentences(text) {
    return text
      .replace(/\s+/g," ")
      .split(/(?<=[.!?])\s+|\n+/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  function classifySentence(sentenceLower) {
    const s = sentenceLower;
    const has = list => list.some(word => s.includes(word));

    if (has(["you have ","has ","diagnosed with","suffers from","is suffering from"])) return "condition";
    if (has(["diagnosis","impression","assessment"])) return "condition";
    if (has(["presenting with","presents with","came because of","came with","history of","complaint","c/o"])) return "condition";

    if (has(["tablet","cap ","capsule","syrup","dose","mg","once daily","twice daily","thrice","bd","tds","start taking","continue","stop"])) {
      return "treatment";
    }

    if (has(["investigation","labs","blood test","x-ray","xray","scan","ct ","mri","ultrasound"])) {
      return "tests";
    }

    if (has(["follow-up","follow up","review","revisit","next visit","come back","return in","see again in"])) {
      return "followup";
    }

    if (has(["emergency","immediately","if you","worsen","gets worse","high fever","chest pain","difficulty breathing","shortness of breath"])) {
      return "warnings";
    }

    return "other";
  }

  function cleanSentenceForPatient(original, extraSimple) {
    let text = original.trim();

    text = text.replace(/^patient[:\s]+/i,"");
    text = text.replace(/^the patient[:\s]+/i,"");
    text = text.replace(/^pt[:\s]+/i,"");

    text = simplifyTerms(text, extraSimple);

    text = text.replace(/\bhe\b/gi,"you");
    text = text.replace(/\bshe\b/gi,"you");
    text = text.replace(/\bthey\b/gi,"you");

    if (extraSimple) {
      const parts = text.split(",");
      if (parts.length > 2) text = parts.slice(0,2).join(",");
    }

    return text.trim();
  }

  function buildBulletSummary(rawText, extraSimple) {
    const simplifiedBlock = simplifyTerms(rawText, extraSimple);
    const sentences = splitSentences(simplifiedBlock);

    const buckets = {
      condition: [],
      treatment: [],
      tests: [],
      followup: [],
      warnings: [],
      other: []
    };

    sentences.forEach(sent => {
      const lower = sent.toLowerCase();
      const category = classifySentence(lower);
      const cleaned = cleanSentenceForPatient(sent, extraSimple);
      if (!cleaned) return;
      buckets[category].push(cleaned);
    });

    const bullets = [];

    if (buckets.condition.length) {
      bullets.push("What the doctor thinks is happening: " + buckets.condition.join(" "));
    }
    if (buckets.treatment.length) {
      bullets.push("What you need to do with medicines or treatment: " + buckets.treatment.join(" "));
    }
    if (buckets.tests.length) {
      bullets.push("Tests or checks the doctor wants: " + buckets.tests.join(" "));
    }
    if (buckets.followup.length) {
      bullets.push("When you should come back: " + buckets.followup.join(" "));
    }
    if (buckets.warnings.length) {
      bullets.push("Important warning signs or when to seek help: " + buckets.warnings.join(" "));
    }
    if (!bullets.length && buckets.other.length) {
      bullets.push("Other information: " + buckets.other.join(" "));
    }

    if (!bullets.length) {
      return ["No clear sentences detected. Try including one or two full sentences from what the doctor said."];
    }

    const top = bullets.slice(0, 6);

    if (extraSimple) {
      return top.map(b => {
        return b
          .replace("What the doctor thinks is happening:","The doctor thinks this is happening:")
          .replace("What you need to do with medicines or treatment:","About your medicines:")
          .replace("Tests or checks the doctor wants:","Tests the doctor wants:")
          .replace("When you should come back:","When you must come back:")
          .replace("Important warning signs or when to seek help:","Watch out for this:");
      });
    }

    return top;
  }

  const summaryList = document.getElementById("summaryList");
  const summaryStatus = document.getElementById("summaryStatus");

  function renderSummary(bullets, label) {
    summaryList.innerHTML = "";
    bullets.forEach(b => {
      const li = document.createElement("li");
      li.className = "text-[12px] text-slate-800";
      li.textContent = b;
      summaryList.appendChild(li);
    });
    summaryStatus.textContent = label;
  }

  function handleExplain(text, extraSimple) {
    const trimmed = text.trim();
    if (!trimmed) {
      renderSummary(
        ["Paste, record, or scan something first. For example, one or two sentences of what the doctor said."],
        "No input"
      );
      return;
    }
    summaryStatus.textContent = "Decoding…";
    const bullets = buildBulletSummary(trimmed, extraSimple);
    renderSummary(bullets, extraSimple ? "Extra simple explanation" : "Standard explanation");
  }

  const plainText = document.getElementById("plainText");
  const fillExample = document.getElementById("fillExample");
  const explainText = document.getElementById("explainText");
  const extraSimpleText = document.getElementById("extraSimpleText");

  fillExample.onclick = () => {
    plainText.value =
      "Patient presents with acute exacerbation of chronic bronchitis. Start oral antibiotics and provide symptomatic relief. Advise adequate hydration, monitor vitals, and schedule follow-up in 3 days to review labs and check for any adverse reaction.";
    plainText.focus();
  };

  explainText.onclick = () => {
    handleExplain(plainText.value, extraSimpleText.checked);
  };

  const recordBtn = document.getElementById("recordBtn");
  const recordDot = document.getElementById("recordDot");
  const recordLabel = document.getElementById("recordLabel");
  const audioStatus = document.getElementById("audioStatus");
  const audioText = document.getElementById("audioText");
  const explainAudio = document.getElementById("explainAudio");
  const extraSimpleAudio = document.getElementById("extraSimpleAudio");

  let recognition = null;
  let isRecording = false;

  if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.lang = "en-IN";
    recognition.interimResults = true;
    recognition.continuous = true;

    recognition.onstart = () => {
      audioStatus.textContent = "Listening… ask the doctor to speak in full sentences.";
    };

    recognition.onerror = e => {
      audioStatus.textContent = "Speech recognition error: " + e.error;
      isRecording = false;
      recordDot.classList.remove("bg-emerald-500");
      recordDot.classList.add("bg-white");
      recordBtn.classList.remove("bg-rose-600");
      recordBtn.classList.add("bg-rose-500");
      recordLabel.textContent = "Start recording";
    };

    recognition.onresult = e => {
      let transcript = "";
      for (let i = 0; i < e.results.length; i++) {
        transcript += e.results[i][0].transcript + " ";
      }
      audioText.value = transcript.trim();
    };

    recognition.onend = () => {
      if (isRecording) {
        audioStatus.textContent = "Stopped listening.";
        isRecording = false;
        recordDot.classList.remove("bg-emerald-500");
        recordDot.classList.add("bg-white");
        recordBtn.classList.remove("bg-rose-600");
        recordBtn.classList.add("bg-rose-500");
        recordLabel.textContent = "Start recording";
      }
    };
  } else {
    audioStatus.textContent = "Speech recognition not supported in this browser. Use Chrome on desktop or Android.";
    recordBtn.disabled = true;
    recordBtn.classList.add("opacity-60","cursor-not-allowed");
  }

  recordBtn.onclick = () => {
    if (!recognition) return;
    if (!isRecording) {
      recognition.start();
      isRecording = true;
      recordDot.classList.remove("bg-white");
      recordDot.classList.add("bg-emerald-500");
      recordBtn.classList.remove("bg-rose-500");
      recordBtn.classList.add("bg-rose-600");
      recordLabel.textContent = "Stop recording";
      audioStatus.textContent = "Listening…";
    } else {
      recognition.stop();
      isRecording = false;
      recordDot.classList.remove("bg-emerald-500");
      recordDot.classList.add("bg-white");
      recordBtn.classList.remove("bg-rose-600");
      recordBtn.classList.add("bg-rose-500");
      recordLabel.textContent = "Start recording";
      audioStatus.textContent = "Stopped recording.";
    }
  };

  explainAudio.onclick = () => {
    handleExplain(audioText.value, extraSimpleAudio.checked);
  };

  const imageInput = document.getElementById("imageInput");
  const ocrStatus = document.getElementById("ocrStatus");
  const ocrText = document.getElementById("ocrText");
  const explainImage = document.getElementById("explainImage");
  const extraSimpleImage = document.getElementById("extraSimpleImage");

  imageInput.onchange = () => {
    const file = imageInput.files && imageInput.files[0];
    if (!file) return;
    ocrStatus.textContent = "Reading prescription…";
    Tesseract.recognize(file, "eng", {
      logger: m => {
        if (m.status === "recognizing text" && m.progress) {
          const pct = Math.round(m.progress * 100);
          ocrStatus.textContent = "Recognising text… " + pct + "%";
        }
      }
    }).then(({ data }) => {
      ocrText.value = (data && data.text ? data.text.trim() : "");
      ocrStatus.textContent = "Finished reading. Edit if needed, then generate an explanation.";
    }).catch(() => {
      ocrStatus.textContent = "Could not read this image. Try a clearer photo or printed text.";
    });
  };

  explainImage.onclick = () => {
    handleExplain(ocrText.value, extraSimpleImage.checked);
  };
</script>
